<!-- app/views/operational_portal/orders/show.html.erb -->
<div class="order-show-container" data-controller="order-status" data-order-status-order-id-value="<%= @order.id %>">
  <h1>Order Details</h1>

  <p><strong>Order ID:</strong> <%= @order.id %></p>
  <p><strong>Customer:</strong> <%= @order.customer.name %></p>
  <p>
    <strong>Status:</strong>
    <%= select_tag :order_status, 
                   options_for_select(Order.statuses.keys.map { |s| [s.titleize, s] }, @order.status), 
                   id: 'order-status-select', 
                   class: 'order-show-status-select',
                   data: { 
                     order_status_target: "status",
                     action: "change->order-status#statusChanged"
                   } %>
  </p>
  <p><strong>Order Date:</strong> <span class="local-time" data-time="<%= @order.created_at.iso8601 %>"><%= @order.created_at.strftime("%B %d, %Y %I:%M %p") %></span></p>
  <p><strong>Total Amount:</strong> <%= number_to_currency(@order.total_amount) %></p>

  <h2>Items</h2>
  <% if @order.order_details.any? %>
    <table class="order-show-items-table">
  <thead>
    <tr>
      <th>Item</th>
      <th>Type</th>
      <th>Quantity</th>
      <th>Price</th>
      <th>Subtotal</th>
    </tr>
  </thead>
  <tbody>
    <% @order.order_details.each do |item| %>
      <tr>
        <td>
          <% if item.product %>
            <%= item.product.name %>
          <% elsif item.part %>
            <%= item.part.name %>
          <% else %>
            Unknown Item
          <% end %>
        </td>
        <td><%= item.product ? 'Product' : 'Part' %></td>
        <td><%= item.quantity || 'N/A' %></td>
        <td><%= number_to_currency(item.price) if item.price %></td>
        <td>
          <% if item.quantity && item.price %>
            <%= number_to_currency(item.quantity * item.price) %>
          <% else %>
            N/A
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
  <% else %>
    <p>No items in this order.</p>
  <% end %>

  <%= link_to 'Back to Orders', operational_portal_orders_path, class: "btn btn-secondary", data: { turbo: false } %>
  
  <button id="save-changes" 
          class="order-show-save-changes" 
          style="display: none;" 
          data-order-status-target="save"
          data-action="click->order-status#save">Save Changes</button>
</div>

<!-- Navigation warning modal -->
<div id="navigation-warning-modal" class="order-show-modal" style="display: none;">
  <div class="order-show-modal-content">
    <h2>Unsaved Changes</h2>
    <p>You have unsaved changes on this order. Would you like to save the changes?</p>
    <button data-action="click->order-status#saveAndNavigate">Yes</button>
    <button data-action="click->order-status#discardAndNavigate">No</button>
    <button data-action="click->order-status#cancelNavigation" class="order-show-close-modal">&times;</button>
  </div>
</div>