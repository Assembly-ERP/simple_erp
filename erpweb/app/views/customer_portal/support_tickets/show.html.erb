<!-- app/views/customer_portal/support_tickets/show.html.erb -->
<h1>Support Ticket Details</h1>

<p><strong>Ticket ID:</strong> <%= @support_ticket.id %></p>
<p><strong>Title:</strong> <%= @support_ticket.title %></p>
<p><strong>Status:</strong> <%= @support_ticket.status %></p>
<p><strong>Created At:</strong> <%= @support_ticket.created_at.strftime("%B %d, %Y %H:%M") %></p>

<h2>Messages</h2>
<ul>
  <% if @support_ticket.support_ticket_messages.any? %>
    <% @support_ticket.support_ticket_messages.each do |support_ticket_message| %>
      <li style="margin-bottom: 1em;">
        <strong>Message Added:</strong> <%= support_ticket_message.created_at.strftime("%B %d, %Y %H:%M") %>
        <div>
          <strong>Message:</strong> <%= support_ticket_message.body %>
        </div>
        <% if support_ticket_message.file.attached? %>
        <div>
        <strong>File:</strong> <%= support_ticket_message.file.filename.to_s %>
        <div>
        <%= link_to "Preview", "#", class: "preview-button", data: { url: rails_blob_path(support_ticket_message.file), content_type: support_ticket_message.file.content_type } %>
        <%= link_to "Download", rails_blob_path(support_ticket_message.file, disposition: "attachment") %>
        </div>
      </div>
        <% end %>
      </li>
    <% end %>
  <% else %>
    <li>No messages found.</li>
  <% end %>
</ul>

<hr style="margin: 2em 0;">

<% if current_user.role == 'customer_user_admin' || (current_user.role == 'customer_user_regular' && @support_ticket.user == current_user) %>
  <h3>Add a New Message</h3>
  <%= form_with model: [@support_ticket, SupportTicketMessage.new], url: add_message_customer_portal_support_ticket_path(@support_ticket), local: true, html: { multipart: true } do |form| %>
    <div class="field">
      <%= form.label :body, "Message" %>
      <%= form.text_area :body %>
    </div>
    <div class="field">
      <%= form.label :file, "File" %>
      <%= form.file_field :file %>
    </div>
    <div class="actions">
      <%= form.submit "Add Message" %>
    </div>
  <% end %>
<% end %>

<%= link_to 'Back to Tickets', customer_portal_support_tickets_path %>

<div id="preview-modal" class="preview-modal">
  <div class="preview-modal-content">
    <span class="close-button">&times;</span>
    <div id="preview-content">Here is Text</div>
  </div>
</div>